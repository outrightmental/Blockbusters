name: "Distribution"
on:
  release:
    types: [ published ]

# NOTE: If your `project.godot` is at the repository root, set `PROJECT_PATH` below to ".".

env:
  GODOT_VERSION: 4.4.1
  EXPORT_NAME: blockbusters
  PROJECT_PATH: .

jobs:
  nothing_left_todo:
    name: Nothing Left TODO
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (with LFS)
        uses: actions/checkout@v2

      - name: Nothing left TODO
        run: .github/nothing_left_todo.sh

  run_all_tests:
    name: Run All Tests
    runs-on: ubuntu-24.04
    container:
      image: barichello/godot-ci:4.4.1
    steps:
      - name: Checkout (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Import assets (first run to generate .godot cache)
        run: |
          godot --headless --path ${PROJECT_PATH} --import --quit || true

      - name: Verify base test scripts are present
        run: |
          test -f scenes/tests/test_base.gd || echo "WARNING: test_base.gd missing (adjust path)."

      - name: Run test suite at default resolution of 1024x576
        run: |
          godot --resolution 1024x576 --headless --path ${PROJECT_PATH} --fixed-fps 30 res://scenes/tests/test_suite.tscn --quit || exit 1

  export-windows-table:
    needs:
      - nothing_left_todo
      - run_all_tests
    name: Export Windows Table
    env:
      ARTIFACT_NAME: blockbusters-${{ github.ref_name }}-windows-table.zip
    runs-on: ubuntu-24.04  # Use 24.04 with godot 4
    container:
      image: barichello/godot-ci:4.4.1
    steps:

      - name: Checkout (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Update config/version in project.godot
        run: |
          TAG_NAME=${{ github.ref_name }}
          sed -i 's/^config\/version=.*/config\/version="${TAG_NAME}"/' project.godot

      - name: Setup
        run: |
          mkdir -v -p ~/.local/share/godot/export_templates/
          mkdir -v -p ~/.config/
          mv /root/.config/godot ~/.config/godot
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable

      - name: Build
        run: |
          mkdir -v -p build/windows
          EXPORT_DIR="$(readlink -f build)"
          cd $PROJECT_PATH
          godot --headless --verbose --export-release "Windows Table" "$EXPORT_DIR/windows/$EXPORT_NAME.exe"

      - name: Compress to Artifact
        run: |
          cd build/windows
          zip -r ../$ARTIFACT_NAME . 

      - name: Upload Artifact to Release Tag
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/${{ env.ARTIFACT_NAME }}
          asset_name: ${{ env.ARTIFACT_NAME }}
          tag: ${{ github.ref }}
          overwrite: true

  export-windows:
    needs:
      - nothing_left_todo
      - run_all_tests
    name: Export Windows Couch
    env:
      ARTIFACT_NAME: blockbusters-${{ github.ref_name }}-windows-couch.zip
    runs-on: ubuntu-24.04  # Use 24.04 with godot 4
    container:
      image: barichello/godot-ci:4.4.1
    steps:

      - name: Checkout (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Update config/version in project.godot
        run: |
          TAG_NAME=${{ github.ref_name }}
          sed -i 's/^config\/version=.*/config\/version="${TAG_NAME}"/' project.godot

      - name: Setup
        run: |
          mkdir -v -p ~/.local/share/godot/export_templates/
          mkdir -v -p ~/.config/
          mv /root/.config/godot ~/.config/godot
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable

      - name: Build
        run: |
          mkdir -v -p build/windows
          EXPORT_DIR="$(readlink -f build)"
          cd $PROJECT_PATH
          godot --headless --verbose --export-release "Windows Couch" "$EXPORT_DIR/windows/$EXPORT_NAME.exe"

      - name: Compress to Artifact
        run: |
          cd build/windows
          zip -r ../$ARTIFACT_NAME . 

      - name: Upload Artifact to Release Tag
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/${{ env.ARTIFACT_NAME }}
          asset_name: ${{ env.ARTIFACT_NAME }}
          tag: ${{ github.ref }}
          overwrite: true

  export-macos:
    needs:
      - nothing_left_todo
      - run_all_tests
    name: macOS Couch Export
    env:
      ARTIFACT_NAME: blockbusters-${{ github.ref_name }}-macOS-couch.zip
    runs-on: ubuntu-24.04  # Use 24.04 with godot 4
    container:
      image: barichello/godot-ci:4.4.1
    steps:

      - name: Checkout (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup
        run: |
          mkdir -v -p ~/.local/share/godot/export_templates/
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable

      - name: Build
        run: |
          mkdir -v -p build/macos
          EXPORT_DIR="$(readlink -f build)"
          cd $PROJECT_PATH
          godot --headless --verbose --export-release "macOS Couch" "$EXPORT_DIR/macos/$EXPORT_NAME.zip"

      - name: Compress to Artifact
        run: |
          cd build/macos
          zip -r ../$ARTIFACT_NAME . 

      - name: Upload Artifact to Release Tag
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/${{ env.ARTIFACT_NAME }}
          asset_name: ${{ env.ARTIFACT_NAME }}
          tag: ${{ github.ref }}
          overwrite: true

  export-linux:
    needs:
      - nothing_left_todo
      - run_all_tests
    name: Linux Couch Export
    env:
      ARTIFACT_NAME: blockbusters-${{ github.ref_name }}-linux-couch.zip
    runs-on: ubuntu-24.04  # Use 24.04 with godot 4
    container:
      image: barichello/godot-ci:4.4.1
    steps:

      - name: Checkout (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup
        run: |
          mkdir -v -p ~/.local/share/godot/export_templates/
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable

      - name: Build
        run: |
          mkdir -v -p build/linux
          EXPORT_DIR="$(readlink -f build)"
          cd $PROJECT_PATH
          godot --headless --verbose --export-release "Linux Couch" "$EXPORT_DIR/linux/$EXPORT_NAME.x86_64"

      - name: Compress to Artifact
        run: |
          cd build/linux
          zip -r ../$ARTIFACT_NAME . 

      - name: Upload Artifact to Release Tag
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/${{ env.ARTIFACT_NAME }}
          asset_name: ${{ env.ARTIFACT_NAME }}
          tag: ${{ github.ref }}
          overwrite: true

#
#  export-web:
#    name: Web Export
#    runs-on: ubuntu-24.04  # Use 24.04 with godot 4
#    container:
#      image: barichello/godot-ci:4.4.1
#    steps:
#      - name: Checkout (with LFS)
#        uses: actions/checkout@v4
#        with:
#          lfs: true
#      - name: Setup
#        run: |
#          mkdir -v -p ~/.local/share/godot/export_templates/
#          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable
#      - name: Web Build
#        run: |
#          mkdir -v -p build/web
#          EXPORT_DIR="$(readlink -f build)"
#          cd $PROJECT_PATH
#          godot --headless --verbose --export-release "Web" "$EXPORT_DIR/web/index.html"
#      - name: Upload Artifact
#        uses: actions/upload-artifact@v4
#        with:
#          name: web
#          path: build/web
#      - name: Install rsync 📚
#        run: |
#          apt-get update && apt-get install -y rsync
#      - name: Deploy to GitHub Pages 🚀
#        uses: JamesIves/github-pages-deploy-action@releases/v4
#        with:
#          branch: gh-pages # The branch the action should deploy to.
#          folder: build/web # The folder the action should deploy.
#
